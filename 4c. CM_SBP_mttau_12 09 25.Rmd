---
title: "2c. CM_mttau_02 24 25"
output: html_document
date: "2025-02-24"
---

# Getting packages into session
```{r packages, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, results = "hide")

library(haven) # inputting data 
library(tidyverse) # data mgmt
library(psych) # easy summary statistics
library(DT) # data tables
library(tableone) # easy table 1 
library(kableExtra) # format kable objects 
library(naniar) # for missingness 
library(survey) # for MSMs 
library(nnet) # multinormal regression
library(cobalt) # examining covariate balance
library(gt) # nice tables
library(broom) # making output nice
options(max.print=100000)
set.cobalt.options(binary='raw', continuous='std') # setting options for checking covariate balance 
```
```{css scroll box for code, include = FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 100px;
}
```
# Uploading data
```{r upload data, include = FALSE}
load(file = "./analysis data/causmed_imp.Rdata") 
view(names(causmed_imp[[1]])) # getting names for reference

# creating dataset with imputed datasets stacked together
imp_stacked <- complete(causmed_imp, "long") # n=71840, v=66, 2 additional variables to label imputations + id 
summary(imp_stacked$".imp")
table(imp_stacked$".imp")
```

# Exposure weights
This accounts for exposure-outcome confounding (race/eth -> neuroimg). We estimate the probability of being Black or Hispanic (numerator), then the probability of being Black or Hispanic conditional on confounders of interest. Will start with age and gender as confounders here since there are very few true confounders of the E-O relationship (many are mediators). 

References:
- https://pmc.ncbi.nlm.nih.gov/articles/PMC3553264/
- https://pubmed.ncbi.nlm.nih.gov/36938776/
- https://pmc.ncbi.nlm.nih.gov/articles/PMC3710547

## Numerator model for exposure
```{r num exp, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
num_race_mttau <- list() # for fitted values
num_race <- list() # numerator for each race/ethnicity 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # multinomial regression to obtain unconditional prob 
  # of being in a race/ethnic group
  num_race_mttau[[i]] <- multinom(as.factor(ethnicity) ~ 1,
                                  data = data)
  
  # obtaining fitted values 
  num_race[[i]] <- num_race_mttau[[i]]$fitted.values %>%
    as.data.frame() %>%
    rename(num_white = White,
           num_black = Black,
           num_hispanic = Hispanic)
  
}

# checking probabilities
## should be the same since we're just estimating unconditioanl probs here 
str(num_race)
summary(num_race[[20]]) # switch index to check all datasets

# cleaning up workspace for next section
rm(i, m, data, num_race_mttau)
```
## Denominator model for exposure
```{r den exp, echo = TRUE}
# Denominator model: probability of being Black or Hispanic, conditional on age and gender 
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
den_race_mttau <- list() # for fitted values
den_race <- list() # numerator for each race/ethnicity 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # multinomial regression to obtain conditional prob 
  # of being in a race/ethnic group
  den_race_mttau[[i]] <- multinom(as.factor(ethnicity) ~ 
                                    age_1 + # using visit 1 age here 
                                    as.factor(gender) +
                                    as.factor(apoe4_positivity), 
                                  data = data)
  
  # obtaining fitted values 
  den_race[[i]] <- den_race_mttau[[i]]$fitted.values %>%
    as.data.frame() %>%
    rename(den_white = White,
           den_black = Black,
           den_hispanic = Hispanic)
  
}

# checking probabilities
## should be the same since we're just estimating unconditioanl probs here 
str(den_race)
summary(den_race[[20]]) # switch index to check all datasets

# cleaning up workspace for next section
rm(i, m, data, den_race_mttau)
```
## Calculating exposure weights
```{r exp IPW, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
imp_stacked_exp <- list() # list for exposure weights 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # Creating stabilized IPW for exposure
  imp_stacked_exp[[i]] <- data %>%
    
    # getting probabilities from the models above
    bind_cols(num_race[[i]],
              den_race[[i]]) %>% 
    
    # creating denominators based on exposure status
    mutate(num_exp = case_when(
      ethnicity == "Black" ~ num_black,
      ethnicity == "Hispanic" ~ num_hispanic,
      ethnicity == "White" ~ num_white,
      TRUE ~ NA)) %>%
    
    # creating denominators based on exposure status
    mutate(den_exp = case_when(
      ethnicity == "Black" ~ den_black,
      ethnicity == "Hispanic" ~ den_hispanic,
      ethnicity == "White" ~ den_white,
      TRUE ~ NA)) %>% 
    
    # creating exposure weights
    mutate(sw_exp = (num_exp/den_exp)) 
  
}
```
## Examining exposure IPWs
Weights have a mean ~1 and none >10. 
```{r check IPW exp, echo = TRUE}
# switch index to check each dataset separately 
summary(imp_stacked_exp[[5]]$num_exp) 
describeBy(imp_stacked_exp[[5]]$num_exp, 
           imp_stacked_exp[[5]]$ethnicity, 
           mat = TRUE) 

summary(imp_stacked_exp[[5]]$den_exp)
describeBy(imp_stacked_exp[[1]]$den_exp, 
           imp_stacked_exp[[1]]$ethnicity, 
           mat = TRUE) 

summary(imp_stacked_exp[[20]]$sw_exp) 
describeBy(imp_stacked_exp[[20]]$sw_exp, 
           imp_stacked_exp[[20]]$ethnicity, 
           mat = TRUE) 

bal.tab(ethnicity ~ age_1 + gender + apoe4_positivity,
        data = imp_stacked_exp[[5]],
        weights = "sw_exp")

# cleaning up work space
rm(i, m, data, num_race, den_race)
```

# Mediator weights
This accounts for mediator-outcome confounding (HTN -> neuroimg). We estimate the probability of having hypertension, then the probability of having hypertension conditional on M-O confounders (age, gender, SES markers [SES is also affected by the exposure, and why we have to use MSMs in the first place]). 

## Numerator model for mediator
```{r num med, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
num_sbp_mttau <- list() # for fitted values
num_med <- list() # numerator for sbp 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # logistic regression to obtain unconditional prob 
  # of being in a race/ethnic group
  num_sbp_mttau[[i]] <- lm(sbpavg ~ 1, data = data)
  
  # obtaining probability density function
  num_med[[i]] <- dnorm(x = data$sbpavg,
                        mean = predict(num_sbp_mttau[[i]]),
                        sd = sd(num_sbp_mttau[[i]]$residuals)) %>% # SD of residuals 
    as.data.frame() %>%
  rename(num_med = ".")
}

# checking probabilities
str(num_med)
summary(num_med[[20]]) # switch index to check all datasets

# cleaning up workspace for next section
rm(i, m, data, num_sbp_mttau)
```
## Denominator model for mediator
```{r den med, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
den_sbp_mttau <- list() # for fitted values
den_med <- list() # denominator for htn

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # linear regression to obtain conditional probability 
  den_sbp_mttau[[i]] <- lm(sbpavg ~
                             as.factor(ethnicity) +
                             age_1 + # using baseline age
                             as.factor(gender) +
                             # SES variables 
                             income +
                             as.factor(hasnoinsurance) +
                             # proximal risk factors
                             bmi +
                             rapa_1_total + # physical act scores
                             rapa_2_total +
                             as.factor(smkever) +  
                             as.factor(apoe4_positivity) + 
                             # lab values for cardiometabolic RF
                             ldl + 
                             gluc + 
                             a1c + 
                             egfr_nonaa + 
                             choltot + 
                             # clinical dx vars
                             as.factor(cdx_dyslipid) + 
                             as.factor(cdx_dm) + 
                             # taking BP meds to continuous model
                             # dbpavg,
                             as.factor(takes_BP_meds),
                        data = data)
  
  # obtaining probability distribution functions 
  den_med[[i]] <- dnorm(x = data$sbpavg, 
                        mean = predict(den_sbp_mttau[[i]]),
                        sd = sd(den_sbp_mttau[[i]]$residuals)) %>% # SD of residuals
    as.data.frame() %>%
    rename(den_med = ".")
}

# checking probabilities
## should be the same since we're just estimating unconditioanl probs here 
str(den_med)
summary(den_med[[20]]) # switch index to check all datasets

# cleaning up workspace for next section
rm(i, m, data, den_sbp_mttau)
```
## Calculating mediator weights
```{r med IPW, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
imp_stacked_med <- list() # list for mediator weights 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # Creating stabilized IPW for exposure
  imp_stacked_med[[i]] <- data %>%
  
  # getting probabilities from the models above
  bind_cols(num_med[[i]], 
            den_med[[i]]) %>% 
    
  # creating mediator weights
  mutate(sw_med = (num_med/den_med))
}

```
## Examining mediator IPWs
Weights mean ~ 1, max ranged from teens to max 43 Will truncate this later when calculating final weights. 
```{r check IPW med, echo = TRUE}
# switch index to check each dataset separately 
summary(imp_stacked_med[[5]]$num_med)
describeBy(imp_stacked_med[[1]]$num_med, 
           imp_stacked_med[[1]]$has_htn, 
           mat = TRUE) 

summary(imp_stacked_med[[1]]$den_med)
describeBy(imp_stacked_med[[1]]$den_med, 
           imp_stacked_med[[1]]$has_htn, 
           mat = TRUE) 

summary(imp_stacked_med[[20]]$sw_med) 
describeBy(imp_stacked_med[[20]]$sw_med, 
           imp_stacked_med[[20]]$has_htn, 
           mat = TRUE) 

bal.tab(has_htn ~ 
          ethnicity +
          age_1 + # using baseline age 
          gender +
          # SES variables 
          edu + 
          income +
          hasnoinsurance + 
          # proximal risk factors
          bmi +
          rapa_1_total + # physical act scores
          rapa_2_total + 
          smkever,
        data = imp_stacked_med[[20]],
        weights = "sw_med")

# cleaning up work space
rm(i, m, data, num_med, den_med)
```
# Selection weights 
This accounts for selection into the imaging cohort, in this case, who got an PET and had tau measured. In theory, this would be the same as the tau-PET measure, but we will estimate separately for each outcome because N's are still different even for same imaging modality. 

## Numerator model for selection
```{r num sel, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
sel_mttau <- list() # for fitted values
num_sel_mttau <- list() # numerator for selection into the subsample 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # logistic regression, prob of being in the WMHV sample 
  sel_mttau[[i]] <- glm(as.factor(hasmttauv2) ~ 1,
                        family = binomial(link = "logit"),
                        data = data)
  
  # obtaining fitted values 
  num_sel_mttau[[i]] <- sel_mttau[[i]]$fitted.values %>%
    as.data.frame() %>%
  rename(num_sel = ".")
}

# checking probabilities
str(num_sel_mttau)
summary(num_sel_mttau[[20]]) # switch index to check all datasets

# cleaning up workspace for next section
rm(i, m, data, sel_mttau)
```
## Denominator model for selection 
```{r den sel, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
sel_mttau <- list() # for fitted values
den_sel_mttau <- list() # numerator for selection into the subsample 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # logistic regression, prob of being in the WMHV sample 
  sel_mttau[[i]] <- glm(as.factor(hasmttauv2) ~ 
                          as.factor(ethnicity) +
                          age_1 + # using baseline age 
                          as.factor(gender) +
                          # SES variables 
                          edu + 
                          income +
                          as.factor(hasnoinsurance) +
                          socsupptot + 
                          # proximal risk factors
                          bmi +
                          rapa_1_total + # physical act scores
                          rapa_2_total + 
                          as.factor(smkever) + 
                          gds_total + 
                          # lab values for cardiometabolic RF
                          ldl + 
                          gluc + 
                          a1c + 
                          egfr_nonaa + 
                          choltot + 
                          # clinical dx vars
                          as.factor(cdx_dep) +
                          as.factor(cdx_dyslipid) + 
                          as.factor(cdx_cvd) + 
                          as.factor(cdx_dm), 
                        family = binomial(link = "logit"),
                        data = data)
  
  # obtaining fitted values 
  den_sel_mttau[[i]] <- sel_mttau[[i]]$fitted.values %>%
    as.data.frame() %>%
  rename(den_sel = ".")
}

# checking probabilities
str(den_sel_mttau)
summary(den_sel_mttau[[20]]) # switch index to check all datasets

# cleaning up workspace for next section
rm(i, m, data, sel_mttau)
```
## Calculating selection weights
```{r sel IPW, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
imp_stacked_sel <- list() # list for selection weights 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # Creating stabilized IPW for selection 
  imp_stacked_sel[[i]] <- data %>%
    
    # getting probabilities from the models above
    bind_cols(num_sel_mttau[[i]], 
              den_sel_mttau[[i]]) %>% 
    
    # creating numerators based on mediator status
    mutate(num_sel_f = case_when(
      hasmttauv2 == 1 ~ num_sel,
      hasmttauv2 == 0 ~ 1-num_sel,
      TRUE ~ NA)) %>%
    
    # creating denominators based on mediator status
    mutate(den_sel_f = case_when(
      hasmttauv2 == 1 ~ den_sel,
      hasmttauv2 == 0 ~ 1-den_sel,
      TRUE ~ NA)) %>%
    
    # creating mediator weights
    mutate(sw_sel = (num_sel_f/den_sel_f))
}
```
## Examining selection IPWs
Weights mean ~ 1, max 10, will consider truncating. 
```{r check sel med, echo = TRUE}
# switch index to check each dataset separately 
summary(imp_stacked_sel[[5]]$num_sel_f)
describeBy(imp_stacked_sel[[5]]$num_sel_f, 
           imp_stacked_sel[[5]]$hasmttauv2, 
           mat = TRUE) 

summary(imp_stacked_sel[[5]]$den_sel_f)
describeBy(imp_stacked_sel[[5]]$den_sel_f, 
           imp_stacked_sel[[5]]$hasmttauv2, 
           mat = TRUE) 

summary(imp_stacked_sel[[5]]$sw_sel) 
describeBy(imp_stacked_sel[[1]]$sw_sel, 
           imp_stacked_sel[[1]]$hasmttauv2, 
           mat = TRUE) 

bal.tab(hasmttauv2 ~ 
          ethnicity +
          age_1 + # using baseline age 
          gender +
          # SES variables 
          edu + 
          income +
          hasnoinsurance + 
          socsupptot + 
          # proximal risk factors
          bmi +
          rapa_1_total + # physical act scores
          rapa_2_total + 
          smkever + 
          gds_total + 
          # lab values for cardiometabolic RF
          ldl + 
          gluc + 
          a1c + 
          egfr_nonaa + 
          choltot + 
          # clinical dx vars
          cdx_dep +
          cdx_dyslipid + 
          cdx_cvd +
          cdx_dm,
        data = imp_stacked_sel[[20]],
        weights = "sw_sel")

# cleaning up work space
rm(i, m, data, num_sel_mttau, den_sel_mttau)
```
# Creating total weights
For exposure weights, we will multiply exposure * selection weights. For the mediator weights, we include exposure, mediator, and selection weights. 
```{r IPW with all, echo = TRUE}
# Prepping some lists/variables for for-loop 
m <- max(imp_stacked$".imp") # number of imputed datasets
imp_stacked_mttau_sbp <- list() # list for mediator weights 

# For-loop to obtain numerator model for exposure 
for (i in seq_along(1:m)){
  
  # extract one imputed dataset at a time
  data <- imp_stacked %>% filter(`.imp` == i)
  
  # Creating stabilized IPW for exposure
  imp_stacked_mttau_sbp[[i]] <- data %>%
    
    # getting probabilities from the models above
    bind_cols(sw_exp = imp_stacked_exp[[i]]$sw_exp, 
              sw_med = imp_stacked_med[[i]]$sw_med,
              sw_sel = imp_stacked_sel[[i]]$sw_sel) %>% 
    
    # creating final exposure weights
    mutate(sw_exp_sel = (sw_exp*sw_sel)) %>% 
    
    ## truncating at 1st and 99th percentile 
    mutate(sw_exp_f = case_when(
      sw_exp_sel < quantile(sw_exp_sel, 0.01) ~ quantile(sw_exp_sel, 0.01),
      sw_exp_sel > quantile(sw_exp_sel, 0.99) ~ quantile(sw_exp_sel, 0.99),
      TRUE ~ sw_exp_sel)) %>% 
    
    # creating final mediator weights
    mutate(sw_med_sel = (sw_exp*sw_med*sw_sel)) %>% 
    
    ## truncating at 1st and 99th percentile 
    mutate(sw_med_f = case_when(
      sw_med_sel < quantile(sw_med_sel, 0.01) ~ quantile(sw_med_sel, 0.01),
      sw_med_sel > quantile(sw_med_sel, 0.99) ~ quantile(sw_med_sel, 0.99),
      TRUE ~ sw_med_sel)) 
  
}
```

## Examining final IPWs
```{r check IPW all, echo = TRUE}
# switch index to check all datasets
summary(imp_stacked_mttau_sbp[[20]]$sw_exp_f) 
describeBy(imp_stacked_mttau_sbp[[20]]$sw_exp_f, 
           imp_stacked_mttau_sbp[[20]]$ethnicity, 
           mat = TRUE) 

summary(imp_stacked_mttau_sbp[[20]]$sw_med_f) 
describeBy(imp_stacked_mttau_sbp[[20]]$sw_med_f, 
           imp_stacked_mttau_sbp[[20]]$ethnicity, 
           mat = TRUE) 

# For exposure weights 
bal.tab(ethnicity ~
          age_1 + # using baseline age 
          gender +
          # SES variables 
          edu + 
          income +
          hasnoinsurance + 
          socsupptot + 
          # proximal risk factors
          bmi +
          rapa_1_total + # physical act scores
          rapa_2_total + 
          smkever + 
          gds_total + 
          # lab values for cardiometabolic RF
          ldl + 
          gluc + 
          a1c + 
          egfr_nonaa + 
          choltot + 
          # clinical dx vars
          cdx_dep +
          cdx_dyslipid + 
          cdx_cvd +
          cdx_dm,
        data = imp_stacked_mttau_sbp[[1]],
        weights = "sw_exp_f",
        which.treat = .all)

exp_cov <- do.call(rbind, imp_stacked_mttau_sbp) %>% 
  select(c("age_1", "ethnicity", "gender", "edu", "income", "hasnoinsurance", "socsupptot", "bmi", "rapa_1_total", "rapa_2_total", "smkever", "gds_total", "ldl", "gluc", "a1c", "egfr_nonaa", "choltot", "cdx_dep", "cdx_dyslipid", "cdx_cvd", "cdx_dm", "sw_exp_f"))

cov_names <- data.frame(
  old = c("age_1", "ethnicity", "gender", "edu", "income", "hasnoinsurance", "socsupptot", "bmi", "rapa_1_total", "rapa_2_total", "smkever", "gds_total", "ldl", "gluc", "a1c", "egfr_nonaa", "choltot", "cdx_dep", "cdx_dyslipid", "cdx_cvd", "cdx_dm", "sw_exp_f"),
  new = c("Age (Years)", "Race/Ethnicity", "Sex/Gender", "Years of Education", "Income", "Has No Insurance", "Social Support Score", "BMI", "Physical Activity Score (Aerobic)", "Physical Activity Score (Strength)", "Ever Smoked", "GDS Score", "LDL-C", "Glucose", "A1C", "EGFR-nonAA", "Total Cholesterol", "Depression", "Dyslipidemia", "CVD", "Diabetes", "IPW for Exposure") ) 

love.plot(ethnicity ~
          age_1 + # using baseline age 
          gender +
          # SES variables 
          edu + 
          income +
          hasnoinsurance + 
          socsupptot + 
          # proximal risk factors
          bmi +
          rapa_1_total + # physical act scores
          rapa_2_total + 
          smkever + 
          gds_total + 
          # lab values for cardiometabolic RF
          ldl + 
          gluc + 
          a1c + 
          egfr_nonaa + 
          choltot + 
          # clinical dx vars
          cdx_dep +
          cdx_dyslipid + 
          cdx_cvd +
          cdx_dm,
          weights = "sw_exp_f",
          data = exp_cov,
          threshold = c(m=0.2),
          var.names = cov_names,
          which.treat = .all,
          title = "Covariate Balance for SBP Exposure Weights (MTL Tau-PET)") -> lp_exp_sbp_mttau

ggsave("./results/lp_exp_sbp_mttau.jpeg",
       dpi = 400,
       plot = lp_exp_sbp_mttau)

# For mediator weights
bal.tab(ethnicity ~
          age_1 + # using baseline age 
          gender +
          # SES variables 
          edu + 
          income +
          hasnoinsurance + 
          socsupptot + 
          # proximal risk factors
          bmi +
          rapa_1_total + # physical act scores
          rapa_2_total + 
          smkever + 
          gds_total + 
          # lab values for cardiometabolic RF
          ldl + 
          gluc + 
          a1c + 
          egfr_nonaa + 
          choltot + 
          # clinical dx vars
          cdx_dep +
          cdx_dyslipid + 
          cdx_cvd +
          cdx_dm,
        data = imp_stacked_mttau_sbp[[1]],
        weights = "sw_med_f",
        which.treat = .all)

med_cov <- do.call(rbind, imp_stacked_mttau_sbp) %>% 
  select(c("age_1", "sbpavg", "ethnicity", "gender", "edu", "income", "hasnoinsurance", "socsupptot", "bmi", "rapa_1_total", "rapa_2_total", "smkever", "gds_total", "ldl", "gluc", "a1c", "egfr_nonaa", "choltot", "cdx_dep", "cdx_dyslipid", "cdx_cvd", "cdx_dm", "sw_med_f"))

cov_names <- data.frame(
  old = c("age_1", "sbpavg", "ethnicity", "gender", "edu", "income", "hasnoinsurance", "socsupptot", "bmi", "rapa_1_total", "rapa_2_total", "smkever", "gds_total", "ldl", "gluc", "a1c", "egfr_nonaa", "choltot", "cdx_dep", "cdx_dyslipid", "cdx_cvd", "cdx_dm", "sw_med_f"),
  new = c("Age (Years)", "SBP", "Race/Ethnicity", "Sex/Gender", "Years of Education", "Income", "Has No Insurance", "Social Support Score", "BMI", "Physical Activity Score (Aerobic)", "Physical Activity Score (Strength)", "Ever Smoked", "GDS Score", "LDL-C", "Glucose", "A1C", "EGFR-nonAA", "Total Cholesterol", "Depression", "Dyslipidemia", "CVD", "Diabetes", "IPW for Mediator") ) 

love.plot(sbpavg ~
          age_1 + # using baseline age 
          gender +
          ethnicity + 
          # SES variables 
          edu + 
          income +
          hasnoinsurance + 
          socsupptot + 
          # proximal risk factors
          bmi +
          rapa_1_total + # physical act scores
          rapa_2_total + 
          smkever + 
          gds_total + 
          # lab values for cardiometabolic RF
          ldl + 
          gluc + 
          a1c + 
          egfr_nonaa + 
          choltot + 
          # clinical dx vars
          cdx_dep +
          cdx_dyslipid + 
          cdx_cvd +
          cdx_dm,
          weights = "sw_med_f",
          data = med_cov,
          threshold = c(m=0.2),
          var.names = cov_names,
          which.treat = .all,
          title = "Covariate Balance for SBP Mediator Weights (MTL Tau-PET)") -> lp_med_sbp_mttau

ggsave("./results/lp_med_sbp_mttau.jpeg",
       dpi = 400,
       plot = lp_med_sbp_mttau)

# table of weights per imputed dataset
do.call(rbind, imp_stacked_mttau_sbp) %>%
  as.data.frame() %>% 
  group_by(`.imp`) %>% 
  summarise(mean_expIPW = mean(sw_exp_f),
            sd_expIPW = sd(sw_exp_f),
            min_expIPW = min(sw_exp_f),
            max_expIPW = max(sw_exp_f),
            mean_medIPW = mean(sw_med_f),
            sd_medIPW = sd(sw_med_f),
            min_medIPW = min(sw_med_f),
            max_medIPW = max(sw_med_f)) %>%
  rename("Mean (Exposure IPW)" = mean_expIPW,
         "SD (Exposure IPW)" = sd_expIPW,
         "Min (Exposure IPW)" = min_expIPW,
         "Max (Exposure IPW)" = max_expIPW,
         "Mean (Mediator IPW)" = mean_medIPW,
         "SD (Mediator IPW)" = sd_medIPW,
         "Min (Mediator IPW)" = min_medIPW,
         "Max (Mediator IPW)" = max_medIPW,
         "Imputation" = `.imp`) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  gt() -> tbl_wgts_mttau_sbp

# saving tables
gtsave(tbl_wgts_mttau_sbp, file = "./results/tbl_wgts_mttau_sbp.docx")

# saving dataset for analysis
save(imp_stacked_mttau_sbp, file = "./analysis data/imp_stacked_mttau_sbp.Rdata")

# cleaning up workspace
rm(i, m, data, imp_stacked_exp, imp_stacked_med, imp_stacked_sel, cov_names, exp_cov, lp_exp_sbp_mttau, lp_med_sbp_mttau, med_cov)
```

# Estimating TE and CDEs for tau 
## Total effect
For total effect, we can model scale(taumedtempsuvr_2) as a function of race/ethnicity, weighted by the exposure IPW.
```{r te mttau, echo = TRUE}
# loading stacked imputed data 
load("./analysis data/imp_stacked_mttau_sbp.Rdata") 

# creating survey design in order to use weights
m <- max(imp_stacked$".imp") # number of imputed datasets
te_mttau <- list() # list for mediator weights 

# For-loop to estimate MSM for total effect of race/ethnicity on logWMHV
for (i in seq_along(1:m)){
  
  # creating survey design to implement weights 
  design_te_mttau <- svydesign(ids = ~1, 
                               weights = ~sw_exp_f, 
                               data = imp_stacked_mttau_sbp[[i]])
  
  # estimating total effect of race/ethnicity on log-transformed WMHV 
  te_mttau[[i]] <- svyglm(scale(taumedtempsuvr_2) ~
                            as.factor(ethnicity),
                            #as.factor(tauscanner_2),  everyone used the same scanner
                          design = design_te_mttau) 
}

# Pooling estimates across imputations 
pool_te_mttau <- as.mira(te_mttau) %>% pool()
summary(pool_te_mttau)

# Making results presentable 
te_mttau_res <- summary(pool_te_mttau, conf.int = TRUE) %>%
  as.data.frame() %>% 
  mutate("Estimate" = estimate) %>% 
  mutate("LCL" = conf.low) %>% 
  mutate("UCL" = conf.high) %>%
  rename("p-value" = p.value) %>% 
  mutate(across(is.numeric, round, 2)) %>%
  mutate("Group" = case_when(
    term == "as.factor(ethnicity)Black" ~ "Black",
    term == "as.factor(ethnicity)Hispanic" ~ "Hispanic")) %>% 
  select(Group, Estimate, LCL, UCL, "p-value") %>% 
  filter(Group %in% c("Black", "Hispanic")) 

te_mttau_res %>% gt()

# cleaning up workspace
rm(i, m, design_te_mttau, te_mttau)
```

## Controlled direct effect
For CDE, we can model scale(absuvr_2) as a function of the race/ethnicity, hypertension, and their interaction, weighted by the SW as calculated by the cumulative product of both the exposure and mediator weights. The estimate for the Black and Hispanic reflect the CDE of those exposures, holding HTN =0, in other words, what is the effect of race/ethnicity if we control hypertension.  
```{r cde mttau, echo = TRUE}
# creating survey design in order to use weights
m <- max(imp_stacked$".imp") # number of imputed datasets
cde_sbp_nhw <- list() # list for results using SBP centered on NHW mean
cde_sbp_aha <- list() # list for results using SBP centered on ACC/AHA SBP goal of <120 as "normal" 
imp_stacked_mttau_sbp2 <- list() # for new datasets created in the loop

# For-loop to estimate MSM for total effect of race/ethnicity on logWMHV
for (i in seq_along(1:m)){
  
  # calculate mean SBP in NHW
  imp_stacked_mttau_sbp[[i]] %>% group_by(ethnicity) %>%
    summarize_at(vars(sbpavg), list(mean_SBP = mean)) %>%
    filter(ethnicity == "White") %>% select(mean_SBP) -> sbp_nhw
  
  # creating SBP variable centered on mean for NHW, i.e. making the mean SBP for NHW the reference value
  # creating SBP variable centered on AHA goal of SBP<120
  imp_stacked_mttau_sbp2[[i]] <- imp_stacked_mttau_sbp[[i]] %>% 
    mutate(sbp_ref_nhw = sbpavg-(sbp_nhw$mean_SBP)) %>%
    mutate(sbp_ref_aha = sbpavg-120)
  
  # creating survey design to implement weights
  design_cde_mttau <- svydesign(ids = ~1, 
                                weights = ~sw_med_f, 
                                data = imp_stacked_mttau_sbp2[[i]])
  
  # estimating CDE of race/ethnicity on MTL tau SUVR, with avg SBP centered on the mean for NHW 
  cde_sbp_nhw[[i]] <- svyglm(scale(taumedtempsuvr_2) ~
                               as.factor(ethnicity)*sbp_ref_nhw,
                            #as.factor(tauscanner_2),  everyone used the same scanner
                            design = design_cde_mttau)
  
  # estimating CDE of race/ethnicity on amyloid SUVR, with avg SBP centered on the AHA goal of SBP<120
  cde_sbp_aha[[i]] <- svyglm(scale(taumedtempsuvr_2) ~
                                as.factor(ethnicity)*sbp_ref_aha,
                            #as.factor(tauscanner_2),  everyone used the same scanner
                              design = design_cde_mttau)
}

# Pooling estimates across imputations 
pool_cde_nhw <- as.mira(cde_sbp_nhw) %>% pool()
summary(pool_cde_nhw)

pool_cde_aha <- as.mira(cde_sbp_aha) %>% pool()
summary(pool_cde_aha)

# Making results presentable 
## For SBP held at NHW mean 
cde_nhw_res <- summary(pool_cde_nhw, conf.int = TRUE) %>%
  as.data.frame() %>% 
  mutate("Estimate" = estimate) %>% 
  mutate("LCL" = conf.low) %>% 
  mutate("UCL" = conf.high) %>%
  rename("p-value" = p.value) %>% 
  mutate(across(is.numeric, round, 2)) %>%
  mutate("Group" = case_when(
    term == "(Intercept)" ~ "Intercept",
    term == "as.factor(ethnicity)Black" ~ "Black",
    term == "as.factor(ethnicity)Hispanic" ~ "Hispanic",
    term == "sbp_ref_nhw" ~ "Systolic Blood Pressure (mmHg), centered at mean for NHW",
    term == "as.factor(ethnicity)Black:sbp_ref_nhw" ~ "Black*SBP",
    term == "as.factor(ethnicity)Hispanic:sbp_ref_nhw" ~ "Hispanic*SBP"))  %>% 
  select(Group, Estimate, LCL, UCL, "p-value") %>% 
  filter(Group %in% c("Black", "Hispanic")) 

cde_nhw_res %>% gt()

## For SBP held at NHW mean 
cde_aha_res <- summary(pool_cde_aha, conf.int = TRUE) %>%
  as.data.frame() %>% 
  mutate("Estimate" = estimate) %>% 
  mutate("LCL" = conf.low) %>% 
  mutate("UCL" = conf.high) %>%
  rename("p-value" = p.value) %>% 
  mutate(across(is.numeric, round, 2)) %>%
  mutate("Group" = case_when(
    term == "(Intercept)" ~ "Intercept",
    term == "as.factor(ethnicity)Black" ~ "Black",
    term == "as.factor(ethnicity)Hispanic" ~ "Hispanic",
    term == "sbp_ref_aha" ~ "Systolic Blood Pressure (mmHg), centered at SBP=120 per AHA",
    term == "as.factor(ethnicity)Black:sbp_ref_aha" ~ "Black*SBP",
    term == "as.factor(ethnicity)Hispanic:sbp_ref_aha" ~ "Hispanic*SBP"))  %>% 
  select(Group, Estimate, LCL, UCL, "p-value") %>% 
  filter(Group %in% c("Black", "Hispanic")) 

cde_aha_res %>% gt()

# cleaning up workspace
rm(i, m, data, design_cde_ab, cde_ab)
```

# Outputting tau results 
```{r res wmhv, echo = TRUE}
mttau_sbp_res <- bind_rows(te_mttau_res,
                           cde_nhw_res,
                           cde_aha_res) %>% 
  gt() %>% 
  tab_row_group(
    label = "Controlled Direct Effects of Race/Ethnicity on MTL Tau-PET SUVR, Setting Mean SBP=120 mmHg",
    rows = 5:6) %>% 
  tab_row_group(
    label = "Controlled Direct Effects of Race/Ethnicity on MTL Tau-PET SUVR, Setting Mean SBP as Mean SBP in NHW",
    rows = 3:4) %>% 
  tab_row_group(
    label = "Total Effects of Race/Ethnicity on MTL Tau-PET SUVR",
    rows = 1:2) 

mttau_sbp_res

save(mttau_sbp_res, file = "./results/mttau_sbp_res") # saving gt version, in case we want to merge gt
mttau_sbp_res %>% gtsave("./results/mttau_sbp_res.docx")
```

